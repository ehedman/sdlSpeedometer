#!/bin/bash

(
    tmpfile=/tmp/$(basename $0).tmp
    if ! hciconfig | grep -q  DOWN; then
        bt="$(hciconfig hci0 | grep Type | awk -F: '{print $1 "\n"}')"
    fi
    ncores="$(grep processor /proc/cpuinfo | wc -l)"
    osrel="$(awk -F= '/VERSION=/{ print "OS " $1 " " $2}' /etc/os-release)"
    usage="$(df -h -x tmpfs /| awk /dev/'{printf "%s=%s Usage=%s", $1, $2, $5}')"
     
    while true; do

        if ! pidof -c yad  &>/dev/null; then
           break
        fi

        awk NF "$tmpfile" 2>/dev/null
        top -n 2 -b | egrep -v 'top|yad' | grep -A 4 PID | awk '{print $NF "\n" $9 "\t\t" $10}' | awk '/--/{x=NR+20;next}(NR<=x){print}' > "$tmpfile" &
        echo -e "-----\n-----"
        echo -e "Network I.F\nI.P Address:"
        echo "$(ip -o addr show scope global | grep -v secondary | awk '{split($4, a, "/"); printf $2  "\n"a[1] "\t# Connected="}; system("iw dev "$2" station dump | grep Station | wc -l")')"
        if [ -n "${bt}" ]; then
            echo -e "-----\n-----"
            echo -e "Bluetooth\nConnection"
            echo "${bt}";
            echo "$(bluetoothctl devices | cut -f2 -d' ' | while read uuid; do bluetoothctl info $uuid; done| awk -F: '/Connected|Name/ {print $1 " " $2}' | grep -B 1 yes | awk NF=NF RS= OFS=' ')"
        fi
        echo -e "-----\n-----"
        echo "CPU temp"
        echo -n "$(($(cat /sys/class/thermal/thermal_zone0/temp) / 1000))Â°C on"
        echo "$(grep "model name" /proc/cpuinfo  | awk -F: 'NR==1{ print $2}') with ${ncores} cores"
        echo "$(uptime -p | awk '{printf "Uptime\n" $0 " on "}') ${osrel}"
        echo -e "Disk usage\n ${usage}"
        sleep 3.4
        echo -e '\f'
    done
)  | yad  --title="System Status" \
             --borders=8 \
             --image="emblem-system" \
             --list \
             --column="PRPOERTY":text \
             --column="VALUE":text \
             --button="REBOOT":1 \
             --button="HALT":2 \
             --button="QUIT":0 \
             --fullscreen

case $? in
    1)
        sudo reboot
    ;;
    2)
        sudo halt
    ;;
    *)
        exit 0
    ;;
esac
if [ $? -eq 1 ]; then
    sudo reboot
fi

if [ $? -eq 2 ]; then
    halt
fi

exit 0
